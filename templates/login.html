{% extends "base.html" %}
{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-5">
            <div class="card shadow-lg border-0">
                <div class="card-header bg-success text-white text-center">
                    <h4>Login</h4>
                </div>
                <div class="card-body p-4">
                    <div id="alertBox" class="alert d-none"></div>

                    <form id="loginForm">
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" id="email" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Password</label>
                            <input type="password" id="password" class="form-control" required>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-success" id="loginBtn">Login</button>
                        </div>
                    </form>
                    
                    <form id="flaskAuthForm" action="/login" method="POST" style="display:none;">
                        <input type="hidden" name="email" id="flaskEmail">
                    </form>

                    <div class="text-center mt-3">
                        <small>Need an account? <a href="/register">Register here</a></small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script>
    // --- I HAVE FILLED IN YOUR REAL KEYS HERE ---
    const firebaseConfig = {
        apiKey: "AIzaSyChYVXkvYgTchL1JK3Z_ESo1ucsbojGOVI",
        authDomain: "rvm-rewards.firebaseapp.com",
        projectId: "rvm-rewards",
        storageBucket: "rvm-rewards.firebasestorage.app",
        messagingSenderId: "586613270766",
        appId: "1:586613270766:web:241393dd194c33dd02ebff",
        measurementId: "G-3Q3XKX0F1D"
    };
    
    // Initialize Firebase
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    document.getElementById("loginForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const email = document.getElementById("email").value;
        const pass = document.getElementById("password").value;
        const alertBox = document.getElementById("alertBox");
        const btn = document.getElementById("loginBtn");

        alertBox.classList.add("d-none");
        btn.disabled = true;

        try {
            // Check password with Firebase
            const userCredential = await auth.signInWithEmailAndPassword(email, pass);
            const user = userCredential.user;

            if (user.emailVerified) {
                // SUCCESS: Email is verified. Log them into Flask.
                document.getElementById("flaskEmail").value = user.email;
                document.getElementById("flaskAuthForm").submit();
            } else {
                // FAIL: Email not verified
                alertBox.className = "alert alert-warning";
                alertBox.innerHTML = "Please verify your email! Check your inbox. <br> <a href='javascript:resend()'>Resend Link</a>";
                alertBox.classList.remove("d-none");
                btn.disabled = false;
                
                // Helper to resend
                window.resend = async () => {
                    await user.sendEmailVerification();
                    alert("Verification link resent!");
                }
            }
        } catch (error) {
            alertBox.className = "alert alert-danger";
            alertBox.innerText = "Login Failed: " + error.message;
            alertBox.classList.remove("d-none");
            btn.disabled = false;
        }
    });
</script>
{% endblock %}